input {
        beats {
                port => 5044
                include_codec_tag => false
        }
}
filter {
       if [document_type] == "honeypot" {
                json {
                        skip_on_invalid_json => true
                        source => "message"
                        remove_field => "host"
			remove_field => "[payload][source]"
                      }
                mutate {
                        add_field => { "[@metadata][_id]" => "%{[_id][$oid]}" }
                        remove_field => ["_id"]
                        gsub => [
				"message", "\\r\\n", ",",
				"[payload][version]", "'", "",
				"[payload][version]", "\"", "",
				"[payload][version]", "\\s+", " "
				]
                        rename => { "[payload][peerIP]" => "peerIP"}
                        rename => { "[payload][hostPort]" => "local_port"}
                        rename => { "[payload][protocol]" => "protocol"}
                        rename => { "[payload][remote_host]" => "peerIP"}
                        rename => { "[payload][local_port]" => "local_port"}
                        rename => { "[payload][connection_protocol]" => "protocol"}
                        rename => { "[payload][source_ip]" => "peerIP"}
                        rename => { "[payload][saddr]" => "peerIP"}
			rename => { "[payload][dport]" => "local_port"}
			rename => { "[payload][sensor_port]" => "local_port"}
			rename => { "[payload][src_ip]" => "peerIP"}
			rename => { "[payload][dst_port]" => "local_port"}
			rename => { "[payload][data_type]" => "protocol"}                                                
                        }
                grok {
                       match => {
                          "message" => [
                             ".*credentials\":\[\[\"%{DATA:userfailed}\",\"%{DATA:passfailed}\"\]\]",
                             ".*loggedin\":\[\"%{DATA:usersuccess}\",\"%{DATA:passsuccess}\"\]",
                             ".*loggedin\":\[%{DATA:unpassuccess}\]",
                             ".*credentials\"\:\[\[%{DATA:unpassfailed}\]\]",
                             ".*User-Agent\:\ %{DATA:user_agent} \(",
                             ".*request_raw\"\:\"%{DATA:attack_method} "
                                       ]
                                  }
                     }
                geoip { source => "peerIP"
                        target => "geoip"
                      }
		mutate {
			convert => { "local_port" => "string" }
			}
                translate {
                        source => "[local_port]"
                        target => "[service_name]"
                        dictionary => {
				"80" => "HTTP (Unencrypted)"
				"443" => "SSL/HTTPS Secure (Encrypted)"
				"22" => "SSH/Secure-FTP (SFTP)"
				"2222" => "SSH-Alternate"
				"1433" => "Microsoft SQL Server"
				"23" => "Telnet"
				"445" => "SMB/Microsoft DS - File Sharing"
				"20" => "FTP - Data Transfer"
				"21" => "FTP - Control"
				"27017" => "MongoDB"
				"1723" => "VPN-PPTP"
				"3306" => "MySQL"
				"135" => "Microsoft RPC/PortMapper"
				"139" => "NetBIOS Session"
				"11211" => "Memcached"
				"42" => "Host Name Server"
				"123" => "NTP"
				"1883" => "IoT-MQTT"
				"1900" => "SSDP"
				"5060" => "VoIP-SIP (Unencrypted)"
				"5061" => "VoIP-TLS-SIP (Encrypted)"
				"10000" => "Webmin/Backup Exec"
				"25" => "SMTP"
				"53" => "DNS"
				"67" => "DHCP - Server"
				"68" => "DHCP - Client"
				"110" => "POP3"
				"143" => "IMAP"
				"465" => "SMTPS (SMTP Secure)"
				"993" => "IMAPS (IMAP Secure)"
				"995" => "POP3S (POP3 Secure)"
				"3389" => "RDP"
				"5432" => "PostgreSQL Database"
				"5900" => "VNC"
				"6379" => "Redis"
				"8080" => "HTTP Alternate/Web Proxy"
				"8443" => "HTTPS Alternate/Web Admin"
				"5985" => "WinRM - HTTP (Unencrypted)"
				"5986" => "WinRM - HTTPS (Encrypted)"
				"1080" => "SOCKS Proxy (SOCKS5 tunneling)"
				"8000" => "Custom HTTP Tunnels/Web Proxies"
				"1701" => "VPN-L2TP"
				"500" => "VPN-IPSec"
				"4500" => "IPSec NAT Traversal"
				"1194" => "OpenVPN (UDP/TCP)"
				}
                        fallback => "unknown"
                        }
       }
}
output {
       if [document_type] == "honeypot" {
                elasticsearch {
			hosts => ["http://localhost:9200"]
#                       hosts => ["https://localhost:9200"]
#			user => "elastic"
#			password => "ubuntuserver1234"
#			ssl => true
#			cacert => "/etc/elasticsearch/elastic-stack-ca.p12"
                        index => "logstash-honeypot-%{+YYYY.MM.dd}"
                        document_id => "%{[@metadata][_id]}"
                }
       }
}
